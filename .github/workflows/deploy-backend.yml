name: Deploy Backend

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1
    
    - name: Get Infrastructure Info
      run: |
        # Get bastion IP
        BASTION_IP=$(aws ec2 describe-instances --filters "Name=tag:Name,Values=*bastion*" "Name=instance-state-name,Values=running" --query "Reservations[0].Instances[0].PublicIpAddress" --output text)
        echo "BASTION_IP=$BASTION_IP" >> $GITHUB_ENV
        
        # Get private instance IPs
        PRIVATE_IPS=$(aws autoscaling describe-auto-scaling-groups --auto-scaling-group-names aws-sec-pillar-prod-asg --query "AutoScalingGroups[0].Instances[?LifecycleState=='InService'].InstanceId" --output text | xargs -I {} aws ec2 describe-instances --instance-ids {} --query "Reservations[0].Instances[0].PrivateIpAddress" --output text | tr '\n' ' ')
        echo "PRIVATE_IPS=$PRIVATE_IPS" >> $GITHUB_ENV
        
        echo "Bastion IP: $BASTION_IP"
        echo "Private IPs: $PRIVATE_IPS"
    
    - name: Create Flask App Script
      run: |
        cat > deploy_flask.sh << 'EOF'
        #!/bin/bash
        set -e
        
        # Update system
        sudo apt update -y
        sudo apt install -y python3 python3-pip
        
        # Create app directory
        sudo mkdir -p /opt/app
        cd /opt/app
        
        # Create Flask app
        sudo tee app.py > /dev/null << 'PYEOF'
        from flask import Flask, request, jsonify
        from flask_cors import CORS
        from datetime import datetime
        
        app = Flask(__name__)
        CORS(app)
        
        @app.route('/health')
        def health():
            return jsonify({
                'status': 'healthy',
                'timestamp': datetime.now().isoformat(),
                'message': 'Company Registration API is running'
            })
        
        @app.route('/api/companies', methods=['POST'])
        def register_company():
            return jsonify({'message': 'Company registered', 'reg_number': 'REG001'})
        
        @app.route('/api/companies/<reg_number>')
        def get_company(reg_number):
            return jsonify({'reg_number': reg_number, 'status': 'pending'})
        
        if __name__ == '__main__':
            app.run(host='0.0.0.0', port=5000)
        PYEOF
        
        # Install dependencies
        sudo pip3 install Flask Flask-CORS
        
        # Stop existing processes
        sudo pkill -f "python3.*app.py" || true
        sleep 2
        
        # Start Flask app
        sudo nohup python3 /opt/app/app.py > /opt/app/app.log 2>&1 &
        sleep 5
        
        # Test
        curl -f http://localhost:5000/health && echo "SUCCESS: Flask deployed!" || echo "FAILED: Flask not responding"
        EOF
        
        chmod +x deploy_flask.sh
    
    - name: Deploy via Bastion
      run: |
        # Create SSH key (you'll need to add your private key as a secret)
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ssh_key
        chmod 600 ssh_key
        
        # Deploy to each private instance via bastion
        for private_ip in $PRIVATE_IPS; do
          echo "Deploying to $private_ip via bastion $BASTION_IP"
          
          # Copy script to bastion
          scp -i ssh_key -o StrictHostKeyChecking=no deploy_flask.sh ubuntu@$BASTION_IP:/tmp/
          
          # Copy script from bastion to private instance and execute
          ssh -i ssh_key -o StrictHostKeyChecking=no ubuntu@$BASTION_IP "
            scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no /tmp/deploy_flask.sh ubuntu@$private_ip:/tmp/ &&
            ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ubuntu@$private_ip 'chmod +x /tmp/deploy_flask.sh && /tmp/deploy_flask.sh'
          "
        done
    
    - name: Test Deployment
      run: |
        # Get ALB DNS
        ALB_DNS=$(aws elbv2 describe-load-balancers --query "LoadBalancers[?contains(LoadBalancerName, 'aws-sec-pillar-prod')].DNSName" --output text)
        
        # Wait for health checks
        echo "Waiting 60 seconds for health checks..."
        sleep 60
        
        # Test ALB
        echo "Testing ALB at: http://$ALB_DNS/health"
        curl -f http://$ALB_DNS/health && echo "üéâ SUCCESS!" || echo "‚ùå FAILED"