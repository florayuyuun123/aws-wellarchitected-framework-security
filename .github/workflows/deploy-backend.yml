name: Deploy Backend

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1
    
    - name: Get Instance IDs
      run: |
        INSTANCE_IDS=$(aws autoscaling describe-auto-scaling-groups --auto-scaling-group-names aws-sec-pillar-prod-asg --query "AutoScalingGroups[0].Instances[*].InstanceId" --output text)
        echo "INSTANCE_IDS=$INSTANCE_IDS" >> $GITHUB_ENV
    
    - name: Deploy to Instances
      run: |
        for instance_id in $INSTANCE_IDS; do
          echo "Deploying to instance: $instance_id"
          
          # Send Flask app
          aws ssm send-command \
            --instance-ids $instance_id \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "sudo apt update -y",
              "sudo apt install -y python3 python3-pip",
              "sudo mkdir -p /opt/app",
              "cd /opt/app",
              "sudo tee app.py > /dev/null <<EOF
from flask import Flask, request, jsonify
from flask_cors import CORS
from datetime import datetime

app = Flask(__name__)
CORS(app)

@app.route(\"/health\")
def health():
    return jsonify({
        \"status\": \"healthy\",
        \"timestamp\": datetime.now().isoformat(),
        \"message\": \"Company Registration API is running\"
    })

@app.route(\"/api/companies\", methods=[\"POST\"])
def register_company():
    return jsonify({\"message\": \"Company registered\", \"reg_number\": \"REG001\"})

@app.route(\"/api/companies/<reg_number>\")
def get_company(reg_number):
    return jsonify({\"reg_number\": reg_number, \"status\": \"pending\"})

if __name__ == \"__main__\":
    app.run(host=\"0.0.0.0\", port=5000)
EOF",
              "sudo pip3 install Flask Flask-CORS",
              "sudo pkill -f \"python3.*app.py\" || true",
              "sudo nohup python3 /opt/app/app.py > /opt/app/app.log 2>&1 &",
              "sleep 5",
              "curl -f http://localhost:5000/health || echo \"Health check failed\""
            ]' \
            --output text
        done